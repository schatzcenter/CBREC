---
author: "Max Blasdel"
title: "First second burn"
output: html_document
date: "June 7th, 2019"
---

# Purpose 
Figure out approach to first and second burn emmissions

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Libraries
```{r message=FALSE}
library(tidyverse)
library(magrittr)
```

Constants
```{r}
path <- "../../data/Tiles/Test_Runs/emissions"
Run1 <- seq(304, 368) # just use one run for testing
```

# Functions
```{r}
getDirs <- function(path, start, end) {
  f <- dir(path, 
           pattern = paste0("^", as.character(seq(start, end)), "$", collapse = "|"),
           full.names = T)
  return(f)
}

getDataBindAll <- function (data) {
        d <- bind_rows(lapply(data, read_rds))
        return(d)
}
```

Year 0 produces two files for some scenarios, one for prescribed burn and one for wildfire after the prescribed burn
```{r}
r <- getDirs(path, start = min(Run1), end = max(Run1))


# I think I want to sum the first and second
getScenariosId <- function(path, id, year) {

  f <- dir(path,
           pattern =paste("-.*-.*-",id, "-", "\\d+","-",year,".rds$", sep = ""),
           recursive = T,
           full.names = T)
  # account for wildfire after RX burn
  # if (year == 0) {
  #  s <- dir(path,
  #          pattern =paste("second-.*-.*-",id, "-", "\\d+","-",year,".rds$", sep = ""),
  #          recursive = T,
  #          full.names = T)
  #  f <- dir(path,
  #          pattern =paste("first-.*-.*-",id, "-", "\\d+","-",year,".rds$", sep = ""),
  #          recursive = T,
  #          full.names = T)
  #  
  #  if (length(s) == 0) { # 'second' burn does not appear in every year zero scenario
  #          return(f)
  #       } else {
  #               message("This runs contains a second burn and I haven't figured out a way to deal with this yet.")
  #       return(list(f,s)) # I want these as seperate lists     
  #         }
  #       } else {
return(f)
          # }
}
```

Do nothing approach produces duplicates for each tile, grouped on tile. For each tile the df will have all the first burns followed by all the second burns

```{r}
d <- getScenariosId(r, 444, year = 0) %>% getDataBindAll()

d$Secondary_Burn

ggplot(d) +
        theme_minimal() +
        geom_boxplot(aes(Secondary_Burn, total_cwd_exposed))

ggplot(d) +
        theme_minimal() +
        geom_boxplot(aes(Secondary_Burn, total_fwd_exposed))
```

histos, showing the differences in these. Should not be grouped as far as data analysis goes
```{r}
ggplot(d) +
        geom_histogram(aes(total_cwd_residue_CO2))

# separate by second burn

s <- d %>% 
        filter(Secondary_Burn == "second")

d <- d %>%
        filter(Secondary_Burn == "first")

ggplot(d) +
        geom_histogram(aes(total_cwd_residue_CO2))

ggplot(s) +
        geom_histogram(aes(total_cwd_residue_CO2))
```



## working
Add emissions together

```{r}
acres_per_cell <- 900 / 4046.86
# define function to convert tons to grams
tonToGrams <- function(x) {x*1000000}
acresToCell <- function(x) {x*acres_per_cell}

year = '0'
id = 444

f <- dir(r,
           pattern =paste("-.*-.*-",id, "-", "\\d+","-",year,".rds$", sep = ""),
           recursive = T,
           full.names = T)

first <- str_subset(f, pattern = "first")
second <- str_subset(f, pattern = "second")

# function for summing second and first burns UNSURE ABOUT USAGE 
getSumDataFrame <- function(x) {
        
        # read in files and prepare for comparison
        first <- first[x] %>% read_rds()
        
        vals <- first[,1:13]
        # only keep numeric columns
        first <- first[,14:77]
        
        # repeat for normal run
        second <- second[x] %>% read_rds()
        second <- second[,14:77]
        
        second <- second %>% 
                mutate_all(.funs = acresToCell)
        
        first <- first %>% 
                mutate_all(.funs = acresToCell)
        
        all <- data.frame(as.matrix(first) + as.matrix(second))
        all <- cbind(vals, all)
        
        return(all)
}

getSumDataFrame(5)
```


Think about adding a function to indicate if a secondary burn occured in the scenario

