---
title: "Rx / Wildfire Distinction Figure"
author: "Max Blasdel"
date: "7/10/2019"
output: html_document
---

# Supplement to the Fire Model Output Figure markdown

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 20)
```

# load libraries
```{r message=FALSE}
library(tidyverse)
library(raster)
library(leaflet) # for raster viewing in script
library(gridExtra) # arrange graphs together
```

Load C-BREC custom functions for data processing

```{r}
source("scripts/post_process/getScenarioFiles.R")
source("scripts/post_process/sumDataFrames.R")
```

# helper function
```{r}
# convert to grams
poundsToGrams <- function(x) {as.integer(round(x * 907185, digits = 0))}
```

# identify some scenarios of interest

Scenario matrix
```{r}
scenarios_matrix <- read_csv("data/SERC/scenarios.csv", col_types = cols())
```

40% thin from below equal disposition
Filter based on criteria to give scenario IDs of interest
```{r}
scenarios_matrix %>% 
        filter(Pulp_Market != "Yes") %>% # filter out pulp markets as these are assumed not to exist for the data
        filter(str_detect(string = Silvicultural_Treatment, pattern = "40_Thin_From_B")) %>% 
        filter(Fraction_Piled == 50)

scenarios_matrix %>% 
        filter(Pulp_Market != "Yes") %>% # filter out pulp markets as these are assumed not to exist for the data
        filter(str_detect(string = Silvicultural_Treatment, pattern = "Clearcut")) %>% 
        filter(Fraction_Piled == 50)
```

Scenarios:
*40% thin from below*
BroadCast - 297
Biomass Removed - 301
No Burn or Biomass Collection - 303
Pile Burn - 307

*Clearcut*
Broadcast - 675
Biomass Removed - 679
NA - 681
Pile Burn - 685

# load data

Prepare data paths
Run for either 40% scenario or Clearcut, just change which is commented out
```{r}
# for 40% scenarios
# scens <- list(297, 301, 303, 307)

# for clearcut
scens <- list(675, 679, 681, 685)

scen_names <- list("Broadcast", "Biomass Removed", "No Action", "Pile Burn")

# three sequences need to be concatenated together to get in correct format
ls1 <- cbrec_Dirs(paste0(here::here(), "/data/Tiles/Test_Runs/emissions/9-Tile-Test-Region"), start = 117, end = 119)
ls2 <- cbrec_Dirs(paste0(here::here(), "/data/Tiles/Test_Runs/emissions/9-Tile-Test-Region"), start = 162, end = 164)
ls3 <- cbrec_Dirs(paste0(here::here(), "/data/Tiles/Test_Runs/emissions/9-Tile-Test-Region"), start = 81, end = 83)

test_folders<- c(ls1,ls2,ls3)
rm(ls1,ls2,ls3)
```

# looking at RX burn and Wildfire separately

Load the dfs which have two burns and graph these seperately
Currently runs twice creating two objects: pile and broadcast that will be arrange below
```{r}
#name <- 1 # broadcase burn scenario
name <- 4 # pile burn scenario

# get all file paths
dfs <- lapply(scens, function(x) {
        cbrec_ScenariosById(test_folders, id = x, year = 0)
})

scen <- cbrec_DataBindTidy(dfs[[name]])

# Methane
strs <- c('total_duff_residue_CH4', 
          'total_foliage_residue_CH4', 
          'total_fwd_residue_CH4',
          'total_cwd_residue_CH4',
          'total_pile_CH4')

strs <- grep(paste(strs, collapse = "|"), names(scen[[1]]))

# set burn order 
burn_order <- c("RX", "Wildfire")

df_out <- list()
for (i in 1:length(scen)) {
        x <- scen[[i]] %>% 
                transmute(Methane = base::rowSums(.[strs]),
                          #Gross = Stem_6t9_tonsAcre + 
                           #       Stem_4t6_tonsAcre + 
                            #      Stem_ge9_tonsAcre + 
                             #     Branch_tonsAcre + 
                              #    Foliage_tonsAcre,
                         # Methane = Methane / Gross, # write over methane with normalized value
                  treatment = burn_order[[i]])
        df_out[[i]] <- x
}
df_out <- do.call(rbind, df_out)

graph <- df_out %>% 
        ggplot() +
        theme_minimal() +
        theme(text = element_text(size = 14)) +
        geom_boxplot(aes(treatment, Methane)) +
        labs(y ="Total Methane (g) / gross material present",
             x = ifelse(name == 1, "Broadcast Burn Scenario", "Pile Burn Scenario"),
             title = scenarioName)

if(name == 4) {
        pile <- graph
} else {
        broadcast <- graph
}
```

grid facet the results

```{r}
grid.arrange(pile, broadcast, ncol = 2)
```




