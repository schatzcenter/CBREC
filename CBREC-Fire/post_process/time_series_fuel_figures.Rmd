---
author: "Max Blasdel"
date: "7/23/19"
title: "Time Series Data of Fire Results"
---
# Purpose
Use the results from the CBREC fire model runs to create time series graphs of emissions
Ongoing work...

Time series was broken out into a seperate markdown due to the different nature of the data structure

# load libraries
```{r message=FALSE}
library(tidyverse)
library(gridExtra) # arrange graphs together
library(ggpubr) # for shared legend
library(scales) # display y-axis with commas
library(grid) # for plotting with shared legend
```

Load C-BREC custom functions for data processing

```{r}
source("getScenarioFiles.R")
source("sumDataFrames.R")
source("getNames.R")

residue_path <- list("No_Action" = "data/UW/residue/NoAction.csv",
                             "Clearcut" = "data/UW/residue/Remove100Percent.csv",
                             "20_Thin_From_Above" = "data/UW/residue/ThinFromAboveRemove20PercentBA.csv",
                             "40_Thin_From_Above" = "data/UW/residue/ThinFromAboveRemove40PercentBA.csv",
                             "60_Thin_From_Above" = "data/UW/residue/ThinFromAboveRemove60PercentBA.csv",
                             "80_Thin_From_Above" = "data/UW/residue/ThinFromAboveRemove80PercentBA.csv",
                             "20_Thin_From_Below" = "data/UW/residue/ThinFromBelowRemove20PercentBA.csv",
                             "40_Thin_From_Below" = "data/UW/residue/ThinFromBelowRemove40PercentBA.csv",
                             "60_Thin_From_Below" = "data/UW/residue/ThinFromBelowRemove60PercentBA.csv",
                             "80_Thin_From_Below" = "data/UW/residue/ThinFromBelowRemove80PercentBA.csv",
                             "20_Proportional_Thin" = "data/UW/residue/ThinProportionalRemove20PercentBA.csv",
                             "40_Proportional_Thin" = "data/UW/residue/ThinProportionalRemove40PercentBA.csv",
                             "60_Proportional_Thin" = "data/UW/residue/ThinProportionalRemove60PercentBA.csv",
                             "80_Proportional_Thin" = "data/UW/residue/ThinProportionalRemove80PercentBA.csv",
                             "Standing_Dead" = "data/UW/residue/Snags.csv")
```

# helper function
```{r}
## Legend function
g_legend<-function(a.gplot){
        tmp <- ggplot_gtable(ggplot_build(a.gplot))
        leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
        legend <- tmp$grobs[[leg]]
        return(legend) }

# convert to grams
poundsToGrams <- function(x) {as.integer(round(x * 907185, digits = 0))}


# convert to grams
poundsToMegagrams <- function(x) {as.double(x) * 0.000453592}

# fun to remove most rows, worried about size of outputs
removeSelect <- function(x) {
        x <- x %>% 
                dplyr::select(FCID2018,
                              Year,
                              Burn_Type,
                              Biomass_Collection,
                              Silvicultural_Treatment,
                              total_fuel_consumed)
        return(x)
}
```

# identify some scenarios of interest

Scenario matrix
```{r}
scenarios_matrix <- read_csv("../../data/SERC/scenarios.csv", col_types = cols())

# Read in file paths for Sierra region
files <- read.csv(paste0(here::here(), "/data/Tiles/Sierra_Subregion_Tiles_clipped_tile-nums.csv"))
```


# Time series

I want to look at fuel consumption over time from the same scenarios
Need to reload data, this may be moved to top of markdown

Re-prepare the data, could set a break earlier on
```{r}
scens <- scenarios_matrix %>% 
        filter(Pulp_Market != "Yes") %>% # filter out pulp markets as these are assumed not to exist for the data
        filter(Fraction_Piled == 50) %>% # only 50% piled to limit
        filter(Burn_Type != "Pile and Broadcast") %>% # rare scenario
        filter(Biomass_Collection != "Piles Only") %>% 
        filter(!(Burn_Type == "Broadcast" & Biomass_Collection == "All Tech Recoverable")) %>% 
# results in a boradcast, pile, wildfire, and wildfire with biomass removal
        dplyr::select(ID, Silvicultural_Treatment) 
```


```{r}
# Subtract out wildfire from Rx/Wildfire scenarios?
rx_only <- "yes"
#rx_only <- "no"

# Sierra Sub Region 7/15/2019
folders <- cbrec_Dirs(path = "../../data/Tiles/Test_Runs/emissions/Sierra-Subregion", files$X3466)
```

Finds all files and prepares time series data, 
takes a while to run
```{r}
years <- seq(0,100,25)

scens <- split(scens, scens$Silvicultural_Treatment)

scens <- lapply(scens, function(x) {
        x %>% 
                dplyr::select(ID) %>% 
                unlist(recursive = F)
})
```

testing, hagrid crashed on the old method
```{r}
folders <- folders[][1:4]

scens <- scens %>% unlist()

# broadcast_burn <- scens[seq(1, length(scens), 4)]
# pile_burn <- scens[seq(2, length(scens), 4)]
# wildfire <- scens[seq(3, length(scens), 4)]
# bio_collect <- scens[seq(4, length(scens), 4)]
```

# calculate amount exposed
This is based on 
```{r}
exposed_scens <- scenarios_matrix %>% 
        filter(Fraction_Scattered == 100 & Burn_Type == "None" & Biomass_Collection == "No" & Pulp_Market == "No")
```

Create function wrapper below to facilitate large data

```{r}
#scenarios <- scens
# creating a wrapper function to run each set of cases through this data aggregation loop
# outputs results as running the function as a whole crashes hagrid, too memory intensive
# @param treat is the folder name location where the fiels will be saved 
dfs_years <- list()

#runAggregateData <- function(scenarios, treat, years) {
# years = 0

for (years in seq(0,100,25)) {
                
        dfs <- lapply(scens, function(x) { # testing try running on one set of scenarios
                cbrec_ScenariosById(folders, id = x, year = years)
                # currently only set up to run for one year at a time, will need to change for time series
        })
        if(rx_only == "yes") {
        dfs <- lapply(dfs, function(x) {
                out <- cbrec_DataBindTidy(x)

                if(length(out) == 2) {
                        return(out[[1]]) # only return first dataframe with prescribed burn emissions
                } else {
                        return(out)
                }
        })
}
      #  dfs <- lapply(dfs, removeSelect) # reconsider this, think about FCID column
        gc()
        
        # convert from grams to megagrams
        dfs <- lapply(dfs, function(x) {
                x %>%
                        mutate_at(.vars = 14:77 , .funs = ~. / 100000) # convert to MG 
        })
## divide emissions by total residue
# initial residue 
dfs <- lapply(dfs, function(x){
        name <- x %>% # extract name of silvicultural treatment
                 select(Silvicultural_Treatment) %>% 
                 distinct() %>% 
                 unlist()
        
        total_exp <- exposed_scens %>% 
                filter(Silvicultural_Treatment == name)
                
        q <- cbrec_ScenariosById(folders, id = total_exp$ID, year = years)
        q <- cbrec_DataBindTidy(q)
        
        q <- q %>% 
                transmute(total_consumed = 
                                  total_fuel_consumed/1000000) # convert to MG
        return(cbind(x, q))
 })

#         # load residue data
# residue <- read_csv(paste0(here::here(), "/", residue_path[[name]]), col_types = cols())
# 
#  # filter residue data to include only those in the current tile
#         residue <- residue %>% 
#                 filter(FCID2018 %in% x$FCID2018)
# 
#         # check on vars numbers
#         residue <- residue %>% 
#                 #mutate_at(.vars = 3:7, .funs = poundsToMegagrams) %>% # convert pounds to grams in same way as outputs
#                 dplyr::select(-TPA)
#             
#         # join gross residue number with original df
#         x <- left_join(x, residue)
#         
#         return(x)
# })

        dfs <- lapply(dfs, function(x) {
        x %>%
                transmute(Year = Year,
                          Biomass_Collection = Biomass_Collection,
                          Silviculture = Silvicultural_Treatment,
                         
                          total_ch4 = 
                                  total_duff_residue_CH4 +
                              total_foliage_residue_CH4 +
                              total_fwd_residue_CH4 +
                              total_cwd_residue_CH4 +
                              total_pile_CH4,
                         
                          total_co2 = 
                                 total_duff_residue_CO2 +
                              total_foliage_residue_CO2 +
                              total_fwd_residue_CO2 +
                              total_cwd_residue_CO2 +
                              total_pile_CO2,
                         
                          total_pm25 = 
                                  total_duff_residue_PM2.5 +
                              total_foliage_residue_PM2.5 +
                              total_fwd_residue_PM2.5 +
                              total_cwd_residue_PM2.5 +
                              total_pile_vdirty_PM2.5,
                         
                          total_pm10 = 
                                  total_duff_residue_PM10 +
                              total_foliage_residue_PM10 +
                              total_fwd_residue_PM10 +
                              total_cwd_residue_PM10 +
                              total_pile_vdirty_PM10,
                          
                         total_exp = total_exp,
                         
                         scen = case_when(Burn_Type == "Broadcast" ~ "Broadcast Burn",
                                           Burn_Type == "Pile" ~ "Pile Burn",
                                           Burn_Type == "None" & Biomass_Collection == "No" ~ "Wildfire",
                                           Burn_Type == "None" & Biomass_Collection != "No" ~ "Biomass Collection & Wildfire")) %>%
                group_by(Year, Silviculture, scen) %>%
                summarise(all_ch4 = mean(total_ch4, na.rm = T),
                          all_co2 = mean(total_co2, na.rm = T),
                          all_pm25 = mean(total_pm25, na.rm = T),
                          all_pm10 = mean(total_pm10, na.rm = T),
                          sum_exp = mean(total_exp, na.rm = T)) %>%
                        ungroup()
})

        dfs <- bind_rows(dfs)
 #       saveRDS(dfs, paste0("../../data/Post_process/testing/time_series/",treat,"/timeSeriesData",years ,".rds"))
        dfs_years[[years + 1]] <- dfs  
        gc()
}

```

Sum data together and convert to relevant units
```{r}
dfs_years <- bind_rows(dfs_years)
```

convert emissions to per exposed

```{r}
#back <- dfs_years

dfs_years <- back

dfs_years %<>%
        mutate(all_ch4 = all_ch4 / sum_exp,
               all_co2 = all_co2 / sum_exp,
               all_pm10 = all_pm10 / sum_exp,
               all_pm25 = all_pm25 / sum_exp)
```

Get name information for graphs

```{r}
dfs_years %<>% 
        ungroup() %>% 
        mutate(Silviculture = gsub("_", " ", Silviculture),
               Silviculture = ifelse(Silviculture != "Clearcut", gsub("0", "0%", Silviculture), Silviculture))

dfs_years <- split(dfs_years, dfs_years$Silviculture)
```

## Line graph

```{r}
plots <- list()

for (i in 1:length(dfs_years)) {
        scenarioName <- dfs_years[[i]]$Silviculture %>% unique()
        
plots[[i]] <- ggplot(dfs_years[[i]], aes(x = Year, y = all_co2, colour = scen)) +
        theme_minimal() +
        geom_line(aes(group = scen), size = 1) +
        labs(y = element_blank(),
             x = element_blank(),
             colour = "Burn Type",
             title = scenarioName) +
        scale_y_continuous(labels = comma_format(),
                           limits = c(0,208)) +
        theme(legend.position = "top")
}

plots[[13]]$data$all_co2 %>% max()
```

```{r}
# Extract legend as a grob
leg = g_legend(plots[[1]])

#blankPlot <- ggplot()+geom_blank(aes(1,1)) + 
#  cowplot::theme_nothing()

q <- grid.arrange(
  arrangeGrob(grobs=lapply(plots, function(p) p + guides(colour = F)), 
              ncol=3,
              bottom=textGrob("Years", gp=gpar(fontsize=15)), 
              left=textGrob("Total CO2 (Tons/Acre)", gp=gpar(fontsize=15), rot=90)),
  leg,
  heights=c(12,1)
)
```

```{r}
ggsave("../../data/Post_process/charts/timeSeries_gross_co2.png", dpi = 400, q, height = 12, width = 12)
```
